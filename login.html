<!DOCTYPE HTML>
<html>
<head>
<meta charset="utf-8"> 
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>The Little Library</title>
<link rel="stylesheet" href="jqm.css" />
<script type="text/javascript" src="json2.js"></script>
<script type="text/javascript" src="sha1.js"></script>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="jquery.couch.js"></script>
<script type="text/javascript" src="jquery.form.js"></script>
<script type="text/javascript" src="jquery.couchapp.js"></script>
<script type="text/javascript" src="jqm.js"></script>
<script type="text/javascript" src="library.js"></script>
</head>
<body>
<div data-role="page" id="login">
	<div data-role="header" data-theme="b">
    	<a href="index.html" rel="external" data-rel="back" data-role="button" data-icon="arrow-l" class="backBtn">Back</a>
    	<h1 data-login="login">The Little Library</h1>               
        <div class="ui-btn-right">
        	<a href="index.html" rel="external" data-role="button" data-icon="home" data-iconpos="notext" class="homeBtn">Home</a>
        </div>
    </div>
    
  
	<div data-role="content" class="content">
        
        <script type="text/javascript">
        	$('div#login').live("pageshow", function() { 
				
				$('label.userLabel').text(libLang.userLabel);
				$('label.passLabel').text(libLang.passLabel);
							
				// Get the user info for authentication
				$.getJSON(currentHost +'/_users', function(userInfo){
					if(userInfo.doc_count >= 2) {
						
						$('.loginBtn span.ui-btn-text').text(libLang.login);
						
						// If logging into online library, make default username same as online library name
						if (onlineBase == window.location.host){
							$('input#username').val(homeURL);
						}
						
						$('input.login').live('click', function(event){
							event.preventDefault();
							
							username = $('input#username').val();
							password = $('input#password').val();
							
							if (onlineBase == window.location.host && username != homeURL){
								alert(libLang.validUser); // Get text for langauge
								return
							}
							if (!username || username.length == 0) {
								alert(libLang.validUser); // Get text for langauge
								return;
							}
							
							if (!password || password.length == 0) {
								alert(libLang.validPassword); // Get text for langauge
								return;
							}
							
							$.couch.login({
								"name": username, 
								"password": password,
								success: function(){
									
									$.mobile.showPageLoadingMsg();
									
									sessionStorage.setItem("current",password);
									
									
									
									
									
									// Check if user is accessing online library
									if (onlineBase != window.location.host){
									
										// Get onlineDB info
										$.getJSON(currentHost +'/_users/org.couchdb.user%3A'+ username, function(userInfoRoot){
											userOnlineDB = userInfoRoot.onlineDB;
											
											// If user doesn't yet have an online library, create one
											if (userOnlineDB == "" || userOnlineDB == "undefined" || userOnlineDB == null){
												$('div').createOnlineDB(username,password);
											}
											else {
												// else 
												
												onlineHomeDB = "https://"+ userOnlineDB +":"+ password +"@"+ onlineBase +"/"+ userOnlineDB;
												homeDB = "http://"+ username +":"+ password +"@"+ dbURL[0] +"/"+ homeURL;
												
												// Replicate from templateDB to local library
												$.ajax({
													url: "/_replicate",
													type: "POST",
													data: JSON.stringify({"source": templateDB, "target": homeDB, "continuous":true}),
													contentType:"application/json"
												});
												
												// Replicate to onlineDB
												$.ajax({
													url: "/_replicate",
													type: "POST",
													async: false,
													data: JSON.stringify({"source": homeDB, "target": onlineHomeDB, "user_ctx": {"name": username},"continuous":true}),
													contentType:"application/json",
													error: function(){
														alert(libLang.noSyncOnline); // Get text for langauge
														window.location.replace("index.html");
													},
													success: function(){
														
														// Replicate from onlineDB
														$.ajax({
															url: "/_replicate",
															type: "POST",
															async: false,
															data: JSON.stringify({"source": onlineHomeDB, "target": homeDB, "continuous":true}),
															contentType:"application/json",
															success: function(){
																window.location.replace("index.html");
															},
															error: function(){
																alert(libLang.noSyncOnline); // Get text for langauge
																window.location.replace("index.html");
															}
														});
													}
												});
											};
										});
									}
									else {
										window.location.replace("index.html");
									};
								}
							});
						});
						
					// If not signed up in the database, load signup page
					} else { 
						
						
						$('.loginBtn .ui-btn-text').text(libLang.createLibrary);
						$('.login').val(libLang.createLibrary);
						
						if (libLang.connectOnline == undefined) {
							libLang.repeatPass = "Repeat Password";
							libLang.connectOnline = "I already have a Little Library, and want to connect to that";
							libLang.onlineUser = "Name of your current online Little Library (the same as your online username)";
							libLang.validOnlineUser = "Fill in the name of your online Little Library";
							libLang.terms = "<h3>End User License Agreement</h3><h4>Terms of Use</h4><p>The Little Library is an application that allows you to upload, store and share content across computers and digital devices, offline and in the cloud. The Little Library provides features that allow you to share your content with others or to make it public. There are many things that users may do with that content (for example, copy it, modify it, or re-share it). Please consider carefully what you choose to share or make public. The Little Library has no responsibility for that activity.</p><p>You must own the copyright to any content that you share using The Little Library. This means that you either created all of the content yourself, or you are sharing content that is previously licensed as Creative Commons, or is in the public domain. All content in The Little Library that you share with others must be licensed under the <a href='http://creativecommons.org/licenses/by-sa/3.0/'>Creative Commons Attribution-ShareAlike 3.0 Unported License</a>, or be in the public domain (if licensed with a different Creative Commons License, GNU Public License, Apache License, MIT License or other open source license, this must be shown explicitly in The Little Library information for that content). All content that you share with anyone using The Little Library must be <a href='http://en.wikipedia.org/wiki/Open_content'>Open Content</a>. In the words of Patrick Henry: &quot;Is life so dear, or peace so sweet, as to be purchased at the price of chains and slavery? Forbid it, Almighty God! I know not what course others may take, but as for me, give me liberty, or give me death!&quot;</p><p>Please note that the default license <em>does allow for commercial uses of your contributions</em>, as long as such uses are compliant with the terms. Content that violates any copyrights may be deleted and you may be prosecuted if you break any copyright laws in your country.</p><h4>Your Responsibilities</h4> <p>Files and other content in The Little Library may be protected by intellectual property rights of others. Please do not copy, upload, download, or share files unless you have the right to do so. You, and not The Little Library, are responsible for ensuring that all applicable copyright laws are being followed. You, not The Little Library, will be fully responsible and liable for what you copy, share, upload, download or otherwise use while using The Little Library. You must not upload spyware or any other malicious software to The Little Library.</p> <p>You are responsible for safeguarding the password that you use to access The Little Library and you agree not to disclose your password to any third party. You are responsible for any activity using your account, whether or not you authorized that activity. You, and not The Little Library, are responsible for maintaining and protecting all of your content. The Little Library will not be liable for any loss or corruption of your content, or for any costs or expenses associated with backing up or restoring any of your content.</p><p>You agree not to misuse The Little Library. For example, you must not, and must not attempt to, use The Little Library to do the following things.</p><ul><li>probe, scan, or test the vulnerability of any system or network;</li><li>breach or otherwise circumvent any security or authentication measures;</li><li>access, tamper with, or use non-public areas of The Little Library, or shared areas of The Little Library you have not been invited to;</li><li>interfere with or disrupt any user, host, or network, for example by sending a virus, overloading, flooding, spamming, or mail-bombing any part of The Little Library;</li><li>plant malware or otherwise use The Little Library to distribute malware;</li><li>access or search The Little Library by any means other than our publicly supported interfaces (for example, &quot;scraping&quot;);</li><li>send or share unsolicited communications, promotions or advertisements, or spam;</li><li>send or share altered, deceptive or false source-identifying information;</li><li>publish anything that is fraudulent, misleading, or infringes another&rsquo;s rights;</li><li>promote or advertise products or services other than your own without appropriate authorization;</li><li>impersonate or misrepresent your affiliation with any person or entity;</li><li>publish or share materials that are unlawfully pornographic or indecent, or that advocate bigotry, religious, racial or ethnic hatred;</li><li>violate the law in any way, or violate the privacy of others, or defame others.</li></ul><h4>Precedence of English Terms</h4><p>If there is any inconsistency between these terms and any translation into other languages, the English language version takes precedence.</h4><h4>Software Licensing</h4><p>The Little Library is licensed under several open source licenses:</p><p>The Little Library application is licensed by Bob Wadholm (Copyright 2011) under Dual licenses: MIT and GPL version 2. The MIT license reads as follows:</p><blockquote>Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the &quot;Software&quot;), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions: The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.<br /><br />THE SOFTWARE IS PROVIDED &quot;AS IS&quot;, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.</blockquote><p>CouchDB is licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not use this software or Website except in compliance with the License. You may obtain a copy of the License at <a href='http://www.apache.org/licenses/LICENSE-2.0'>http://www.apache.org/licenses/LICENSE-2.0</a>. Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions and limitations under the License.</p><p>The PHP proxy is partially based on <a href='http://bit.ly/15X5zm'>http://bit.ly/15X5zm</a> and is released under the Apache License Version 2.</p><p>The client-side URL parameter functionality is derived and adapted from: <a href='http://bit.ly/HdUdO'>http://bit.ly/HdUdO</a></p><h4>Limitations of Liability</h4><p>Software and services provided under this agreement are provided to you as is and with no warranties whatsoever. All implied warranties are excluded to the extent legally permissible. The Little Library is not responsible for the loss of any of your data or any loss of business or financial disadvantage to you as a result of any loss of or damage to your data as a consequence of your use of the services. You should ensure that you have suitable backups of all data.</p>"
							libLang.acceptTerms = "I accept the terms of the Agreement";
							libLang.noSyncOnline = "Not able to sync changes with online library";
							libLang.createSync = "Created and synced with online library.";
							libLang.noOnline = "Not able to set up online library."; 
						}
						$('.passwordField').after('<div data-role="fieldcontain" class="repeatPasswordField"><label for="password2" class="ui-input-text">'+ libLang.repeatPass +'</label><input type="password" name="password2" id="password2" data-inline="true" class="ui-input-text ui-body-null ui-corner-all ui-shadow-inset ui-body-c" /></div>');
						
						
						$('.loginBtn').before('<br /><div data-role="fieldcontain" class="ui-field-contain ui-body ui-br" style="display: block;"><input type="checkbox" name="connectOnline" id="connectOnline" value="Yes"><label for="connectOnline" class="connectOnlineLabel"><strong> '+ libLang.connectOnline +'</strong></label></div><div class="onlineUserDiv" style="display: none"><label for="onlineUser" class="ui-input-text">'+ libLang.onlineUser +'</label><input type="text" name="onlineUser" id="onlineUser" data-inline="true" class="ui-input-text ui-body-null ui-corner-all ui-shadow-inset ui-body-c" /></div><div class="terms" style="margin: 20px 0px; border: 1px solid #ccc; padding: 0px 20px; border-radius: 10px; background: #fff;">'+ libLang.terms +'</div><div data-role="fieldcontain" class="acceptTermsDiv ui-field-contain ui-body ui-br" style="display: block;"><input type="checkbox" name="acceptTerms" id="acceptTerms" value="Yes">&nbsp;&nbsp;<label for="acceptTerms" class="acceptTermsLabel">'+ libLang.acceptTerms +'</label></div>');
						
						$('input#connectOnline').live('click', function(event){
							
							$('.acceptTermsDiv').fadeToggle();
							$('.terms').fadeToggle(function(){
								$('.onlineUserDiv').fadeToggle();
							});
						});
						
					
						
						// Sign up new user and create new library and/or connect to previous account
						$('input.login').live('click', function(event){
							event.preventDefault();
							
							username = $('input#username').val();
							password = $('input#password').val();
							password2 = $('input#password2').val();
							acceptTerms = $('input#acceptTerms:checked').val();
							connectOnline = $('input#connectOnline:checked').val();
							
							if (!username || username.length == 0) {
								alert(libLang.validUser); 
								return;
							}
							
							if (password != password2) {
								alert(libLang.validPassword); 
								return;
							}
							
							if (!password || password.length == 0) {
								alert(libLang.validPassword); 
								return;
							}
							
							// Fade out login button so that users don't keep pushing it ;)
							//$('input.login').remove();
							
							// Set delayed commits to "false" in the config file for added stability
							$.ajax({
								url: "/_config/couchdb/delayed_commits",
								type: "PUT",
								async: false,
								data: JSON.stringify("false"),
								contentType:"application/json"
							});
							
							// Change automatic logout from 10 minutes to 100 minutes
							$.ajax({
								url: "/_config/couch_httpd_auth/timeout",
								type: "PUT",
								async: false,
								data: JSON.stringify("60000"),
								contentType:"application/json"
							});
							
							// Set up user as database admin
							$.ajax({
								url: "/_config/admins/"+ username,
								type: "PUT",
								async: false,
								data: JSON.stringify(password),
								contentType:"application/json",
								success: function(){
									
									$.couch.login({
										"name": username, 
										"password": password,
										success: function(){
									
										// If user has no previous library, create one
										if (connectOnline != "Yes"){
												
											if (acceptTerms != "Yes") {
												alert(libLang.acceptTermsNo); // Get text for langauge
												return;
											}
											
											sessionStorage.setItem("current",password);
											
											$('.loginForm').signupForm(username, password);	
											
										}
										
										// Else, setup user and local library, and replicate with specified online library
										else {
											
											onlineUser = $('input#onlineUser').val();
											
											if (!onlineUser || onlineUser.length == 0) {
												alert(libLang.validOnlineUser); // Get text for langauge
												return;
											}
											
											$.couch.signup({"name": username,"onlineDB":onlineUser,"roles":[username]}, password, {
												success: function(){ 
													
													$.mobile.pageLoading();
													
													sessionStorage.setItem("current",password);
													
													secureOnlineDB = 'https://'+ onlineUser +':'+ password +'@'+ onlineBase +'/'+ onlineUser;
								
														
													// Replicate from templateDB to local library
													$.ajax({
														url: "/_replicate",
														type: "POST",
														async: false,
														data: JSON.stringify({"source": templateDB, "target": homeDB, "continuous":true}),
														contentType:"application/json",
														error: function(){
															alert(libLang.noSyncOnline); // Get text for language
															window.location.replace("login.html");
														}
													});
													
													// Replicate to onlineDB from local library
													$.ajax({
														url: "/_replicate",
														type: "POST",
														async: false,
														data: JSON.stringify({"source": homeDB, "target": secureOnlineDB, "continuous":true}),
														contentType:"application/json",
														success: function(){
															alert(libLang.createSync); // Get text for language
															window.location.replace("login.html");
														},
														error: function(){
															alert(libLang.noSyncOnline); // Get text for language
															window.location.replace("login.html");
														}
													});
												}
											});
								
										};
										}
									});
								}
							});
						});
					};
				});
			});
        </script>
        
    	<form class="loginForm" method="post" action="" enctype="multipart/form-data">
            
            <div data-role="fieldcontain">
                <label for="username" class="userLabel">Username:</label>
                <input type="text" name="username" id="username" data-inline="true" />
            </div>
            
            <div data-role="fieldcontain" class="passwordField">
                <label for="password" class="passLabel">Password:</label>
                <input type="password" name="password" id="password" data-inline="true" />
            </div>
            
            <div data-role="fieldcontain" class="loginBtn">
                <input type="submit" data-theme="b" class="login" value="Login" />
            </div> 
            
        </form>
        
	</div> 
    
    
	<div data-role="footer">
        <h4><a href="http://thelittlelibrary.com">thelittlelibrary.com</a></h4> 
    </div>
</div>
</body>
</html>